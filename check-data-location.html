<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فحص بيانات الخزينة</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .data-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            direction: ltr;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .info { background-color: #d6eaf8; color: #1f618d; }
        .warning { background-color: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 فحص بيانات الخزينة المالية</h1>
        
        <div class="status info">
            <strong>الغرض:</strong> هذه الصفحة تساعدك في معرفة مكان حفظ بيانات الخزينة حالياً
        </div>

        <button onclick="checkLocalStorageData()">فحص بيانات localStorage</button>
        <button onclick="testBackendAPI()">اختبار الـ API الخلفي</button>
        <button onclick="clearLocalStorage()">مسح بيانات localStorage</button>

        <h2>📊 بيانات الخزينة في localStorage:</h2>
        <div id="localStorage-data" class="data-box">اضغط على "فحص بيانات localStorage" لعرض البيانات</div>

        <h2>🌐 اختبار الاتصال بالـ API:</h2>
        <div id="api-status" class="data-box">اضغط على "اختبار الـ API الخلفي" لفحص الاتصال</div>

        <h2>📋 التشخيص:</h2>
        <div id="diagnosis" class="status info">
            <strong>الوضع الحالي:</strong> لم يتم الفحص بعد
        </div>
    </div>

    <script>
        function checkLocalStorageData() {
            const safeData = localStorage.getItem('financial-safe-state');
            const projectsData = localStorage.getItem('financial-projects');
            const invoicesData = localStorage.getItem('financial-invoices');
            const employeesData = localStorage.getItem('financial-employees');
            const expensesData = localStorage.getItem('financial-expenses');

            let result = '';
            let hasData = false;

            if (safeData) {
                hasData = true;
                const parsed = JSON.parse(safeData);
                result += `🏦 بيانات الخزينة موجودة في localStorage:\n`;
                result += `الرصيد الحالي: ${parsed.currentBalance} دينار\n`;
                result += `إجمالي التمويل: ${parsed.totalFunded} دينار\n`;
                result += `إجمالي الإنفاق: ${parsed.totalSpent} دينار\n`;
                result += `عدد المعاملات: ${parsed.transactions ? parsed.transactions.length : 0}\n\n`;
                
                if (parsed.transactions && parsed.transactions.length > 0) {
                    result += `آخر المعاملات:\n`;
                    parsed.transactions.slice(0, 3).forEach((t, i) => {
                        result += `${i+1}. ${t.description} - ${t.amount} دينار (${t.date})\n`;
                    });
                }
            }

            if (projectsData) {
                const parsed = JSON.parse(projectsData);
                result += `\n📁 المشاريع: ${parsed.length} مشروع في localStorage\n`;
            }

            if (invoicesData) {
                const parsed = JSON.parse(invoicesData);
                result += `📄 الفواتير: ${parsed.length} فاتورة في localStorage\n`;
            }

            if (employeesData) {
                const parsed = JSON.parse(employeesData);
                result += `👥 الموظفون: ${parsed.length} موظف في localStorage\n`;
            }

            if (expensesData) {
                const parsed = JSON.parse(expensesData);
                result += `💰 المصروفات: ${parsed.length} مصروف في localStorage\n`;
            }

            if (!hasData) {
                result = '❌ لا توجد بيانات في localStorage';
                document.getElementById('diagnosis').innerHTML = `
                    <strong>التشخيص:</strong> لا توجد بيانات محفوظة حالياً
                `;
                document.getElementById('diagnosis').className = 'status warning';
            } else {
                document.getElementById('diagnosis').innerHTML = `
                    <strong>التشخيص:</strong> البيانات محفوظة في localStorage (المتصفح)
                    <br><strong>الحالة:</strong> النظام يعمل بالطريقة القديمة (بدون قاعدة بيانات)
                `;
                document.getElementById('diagnosis').className = 'status warning';
            }

            document.getElementById('localStorage-data').textContent = result;
        }

        async function testBackendAPI() {
            const apiUrl = 'http://localhost:8000';
            let result = '';

            try {
                // Test health endpoint
                result += '🔍 فحص الاتصال بالخادم...\n';
                const healthResponse = await fetch(`${apiUrl}/health`);
                
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    result += `✅ الخادم يعمل: ${healthData.message}\n\n`;
                    
                    // Test Safe API (without authentication for now)
                    result += '🔍 فحص API الخزينة...\n';
                    const safeResponse = await fetch(`${apiUrl}/api/safe/state`);
                    
                    if (safeResponse.ok) {
                        const safeData = await safeResponse.json();
                        result += `✅ API الخزينة يعمل!\n`;
                        result += `الرصيد من قاعدة البيانات: ${safeData.data.current_balance} دينار\n`;
                        
                        document.getElementById('diagnosis').innerHTML = `
                            <strong>التشخيص:</strong> الخادم وقاعدة البيانات يعملان!
                            <br><strong>المشكلة:</strong> الواجهة الأمامية لا تزال تستخدم localStorage
                            <br><strong>الحل:</strong> نحتاج لتحديث الواجهة لتستخدم API
                        `;
                        document.getElementById('diagnosis').className = 'status success';
                    } else if (safeResponse.status === 401) {
                        result += `🔐 API الخزينة يتطلب تسجيل دخول\n`;
                        result += `هذا طبيعي - API يعمل لكن يحتاج مصادقة\n`;
                        
                        document.getElementById('diagnosis').innerHTML = `
                            <strong>التشخيص:</strong> الخادم يعمل وAPI الخزينة متاح
                            <br><strong>الحالة:</strong> يتطلب مصادقة (هذا طبيعي)
                            <br><strong>الحل:</strong> نحتاج لتحديث الواجهة لتستخدم API
                        `;
                        document.getElementById('diagnosis').className = 'status success';
                    } else {
                        result += `❌ خطأ في API الخزينة: ${safeResponse.status}\n`;
                    }
                } else {
                    result += `❌ الخادم لا يعمل: ${healthResponse.status}\n`;
                }
            } catch (error) {
                result += `❌ خطأ في الاتصال: ${error.message}\n`;
                result += `تأكد من تشغيل الخادم: npm run dev في مجلد backend\n`;
                
                document.getElementById('diagnosis').innerHTML = `
                    <strong>التشخيص:</strong> الخادم غير متاح
                    <br><strong>المطلوب:</strong> تشغيل الخادم أولاً
                    <br><strong>الأمر:</strong> cd backend && npm run dev
                `;
                document.getElementById('diagnosis').className = 'status warning';
            }

            document.getElementById('api-status').textContent = result;
        }

        function clearLocalStorage() {
            if (confirm('هل أنت متأكد من مسح جميع البيانات المحفوظة في localStorage؟')) {
                localStorage.removeItem('financial-safe-state');
                localStorage.removeItem('financial-projects');
                localStorage.removeItem('financial-invoices');
                localStorage.removeItem('financial-employees');
                localStorage.removeItem('financial-expenses');
                
                alert('تم مسح جميع البيانات من localStorage');
                checkLocalStorageData();
            }
        }

        // Auto-check on page load
        window.onload = function() {
            checkLocalStorageData();
        };
    </script>
</body>
</html> 